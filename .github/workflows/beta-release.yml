name: Build Beta & Release

on:
  push:
    branches: [ main, master ]          # å¯æ ¹æ®éœ€è¦è°ƒæ•´åˆ†æ”¯
  pull_request:
    branches: [ main, master ]          # å¯é€‰ï¼Œå¢åŠ  PR éªŒè¯
  workflow_dispatch:
    inputs:
      create_release:
        description: 'åˆ›å»º Release (å‹¾é€‰åéœ€å¡«å†™æ ‡ç­¾)'
        required: false
        default: false
        type: boolean
      release_tag:
        description: 'Release æ ‡ç­¾ (ä¾‹å¦‚: v1.2.3)'
        required: false
        type: string
      release_name:
        description: 'Release åç§° (ç•™ç©ºåˆ™ä½¿ç”¨æ ‡ç­¾)'
        required: false
        type: string
      prerelease:
        description: 'æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Determine Build Variant
        id: variant
        run: |
          if [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "BUILD_TASK=assembleRelease" >> $GITHUB_ENV
            echo "APK_PATH=app/build/outputs/apk/release" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=release-apk" >> $GITHUB_ENV
          else
            echo "BUILD_TASK=assembleDebug" >> $GITHUB_ENV
            echo "APK_PATH=app/build/outputs/apk/debug" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=debug-apk" >> $GITHUB_ENV
          fi

      - name: Build APK
        run: ./gradlew ${{ env.BUILD_TASK }} --no-daemon

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.APK_PATH }}/*.apk
          retention-days: 30

  release:
    needs: build
    if: github.event.inputs.create_release == 'true' && github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write          # éœ€è¦æ¨é€æ ‡ç­¾å’Œåˆ›å»º Release

    steps:
      - name: Checkout repository (with full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate release inputs
        run: |
          if [[ -z "${{ github.event.inputs.release_tag }}" ]]; then
            echo "âŒ é”™è¯¯: åˆ›å»º Release æ—¶å¿…é¡»æä¾› release_tag"
            exit 1
          fi
          if [[ ! "${{ github.event.inputs.release_tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "âŒ é”™è¯¯: æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ vX.Y.Z æ ¼å¼ï¼ˆä¾‹å¦‚ v1.2.3ï¼‰"
            exit 1
          fi
          if git tag --list | grep -q "^${{ github.event.inputs.release_tag }}$"; then
            echo "âŒ é”™è¯¯: æ ‡ç­¾ ${{ github.event.inputs.release_tag }} å·²å­˜åœ¨"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Generate release notes (from previous tag to HEAD)
        id: changelog
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ğŸ“ é¦–ä¸ªç‰ˆæœ¬ï¼Œç”Ÿæˆæ‰€æœ‰æäº¤çš„æ›´æ–°æ—¥å¿—"
            git-cliff --unreleased --output RELEASE_NOTES.md
          else
            echo "ğŸ“ ç”Ÿæˆä» $PREVIOUS_TAG åˆ°å½“å‰æäº¤çš„æ›´æ–°æ—¥å¿—"
            git-cliff ${PREVIOUS_TAG}..HEAD --unreleased --output RELEASE_NOTES.md
          fi
          echo "ğŸ“‹ ç”Ÿæˆçš„ Release è¯´æ˜ï¼š"
          cat RELEASE_NOTES.md

      - name: Create and push tag
        run: |
          git tag ${{ github.event.inputs.release_tag }}
          git push origin ${{ github.event.inputs.release_tag }}

      - name: Update full CHANGELOG.md (optional)
        run: |
          git-cliff --output CHANGELOG.md
          if [ -n "$(git status --porcelain CHANGELOG.md)" ]; then
            git add CHANGELOG.md
            git commit -m "docs: æ›´æ–° CHANGELOG.md ä¸º ${{ github.event.inputs.release_tag }}"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
            echo "âœ… CHANGELOG.md å·²æ›´æ–°å¹¶æ¨é€"
          else
            echo "â„¹ï¸ CHANGELOG.md æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: ./apk

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.release_tag }}
          body_path: RELEASE_NOTES.md
          draft: true
          prerelease: ${{ github.event.inputs.prerelease }}
          files: ./apk/**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "ğŸ‰ Release è‰ç¨¿åˆ›å»ºæˆåŠŸï¼"
          echo "  æ ‡ç­¾: ${{ github.event.inputs.release_tag }}"
          echo "  åç§°: ${{ github.event.inputs.release_name || github.event.inputs.release_tag }}"
          echo "  é¢„å‘å¸ƒ: ${{ github.event.inputs.prerelease }}"
          echo "ğŸ”— æŸ¥çœ‹åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.release_tag }}"